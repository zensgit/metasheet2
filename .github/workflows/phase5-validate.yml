name: Phase 5 PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      METRICS_URL: ${{ secrets.METRICS_URL }}
      METRICS_AUTH_HEADER: ${{ secrets.METRICS_AUTH_HEADER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure metrics URL configured
        id: config
        shell: bash
        run: |
          if [ -z "${METRICS_URL}" ]; then
            echo "METRICS_URL secret not set; skipping PR validation (non-blocking)." > unreachable.txt
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Using METRICS_URL=${METRICS_URL}"
          fi

      - name: Probe metrics endpoint
        if: steps.config.outputs.skip != 'true'
        id: probe
        shell: bash
        run: |
          set -e
          HDRS=()
          if [ -n "${METRICS_AUTH_HEADER}" ]; then
            HDRS=( -H "${METRICS_AUTH_HEADER}" )
          fi
          if ! curl -sS -I "${METRICS_URL}" "${HDRS[@]}" | head -n 1 | grep -q "200"; then
            if ! curl -sS "${METRICS_URL}" "${HDRS[@]}" | head -n 1 >/dev/null; then
              echo "Metrics endpoint unreachable: ${METRICS_URL}" > unreachable.txt
              echo "skip=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Set up Node
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable corepack and install deps
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        shell: bash
        run: |
          corepack enable
          pnpm -v || npm i -g pnpm@8
          pnpm install --frozen-lockfile


      - name: Run Phase 5 validation
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        shell: bash
        env:
          METRICS_URL: ${{ env.METRICS_URL }}
          METRICS_AUTH_HEADER: ${{ env.METRICS_AUTH_HEADER }}
        run: |
          if [ -n "${METRICS_AUTH_HEADER}" ]; then
            export EXTRA_CURL_HEADER="${METRICS_AUTH_HEADER}"
          fi
          bash scripts/phase5-full-validate.sh "${METRICS_URL}" /tmp/phase5.json
          bash scripts/phase5-generate-report.sh /tmp/phase5.json /tmp/phase5.md

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase5-pr-validation
          path: |
            /tmp/phase5.json
            /tmp/phase5.md
            unreachable.txt

      - name: Gate PR on failure
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        shell: bash
        run: |
          STATUS=$(jq -r '.summary.overall_status' /tmp/phase5.json || echo 'fail')
          echo "Overall status: ${STATUS}"
          if [ "${STATUS}" != "pass" ]; then
            echo "Phase 5 validation failed (overall_status=${STATUS})." >&2
            exit 1
          fi
