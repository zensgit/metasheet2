name: Build and Push Docker Images

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'docs/**'
      - 'output/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push backend
        run: |
          docker build -f Dockerfile.backend \
            -t ghcr.io/zensgit/metasheet2-backend:latest \
            -t ghcr.io/zensgit/metasheet2-backend:${{ github.sha }} \
            .
          docker push ghcr.io/zensgit/metasheet2-backend:latest
          docker push ghcr.io/zensgit/metasheet2-backend:${{ github.sha }}
      
      - name: Build and push frontend
        run: |
          docker build -f Dockerfile.frontend \
            -t ghcr.io/zensgit/metasheet2-web:latest \
            -t ghcr.io/zensgit/metasheet2-web:${{ github.sha }} \
            .
          docker push ghcr.io/zensgit/metasheet2-web:latest
          docker push ghcr.io/zensgit/metasheet2-web:${{ github.sha }}
      
      - name: Set packages to private
        run: |
          gh api --method PATCH /user/packages/container/metasheet2-backend -f visibility=private || true
          gh api --method PATCH /user/packages/container/metasheet2-web -f visibility=private || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Remote deploy (with preflight logs)
        id: remote_deploy
        continue-on-error: true
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY_B64: ${{ secrets.DEPLOY_SSH_KEY_B64 }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_COMPOSE_FILE: ${{ secrets.DEPLOY_COMPOSE_FILE }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s' "$DEPLOY_SSH_KEY_B64" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh_opts="-o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ~/.ssh/deploy_key"
          DEPLOY_PATH="${DEPLOY_PATH:-metasheet2}"
          DEPLOY_COMPOSE_FILE="${DEPLOY_COMPOSE_FILE:-docker-compose.app.yml}"
          mkdir -p output/deploy
          deploy_log="output/deploy/deploy.log"
          remote_cmds=(
            "set -euo pipefail"
            "DEPLOY_PATH=\"${DEPLOY_PATH:-metasheet2}\""
            "DEPLOY_COMPOSE_FILE=\"${DEPLOY_COMPOSE_FILE:-docker-compose.app.yml}\""
            "cd \"${DEPLOY_PATH}\""
            "# Keep host-mounted config (e.g. docker/nginx.conf) in sync with main."
            "git rev-parse --is-inside-work-tree >/dev/null 2>&1 || { echo \"[deploy][error] DEPLOY_PATH is not a git repo: ${DEPLOY_PATH}\" >&2; exit 1; }"
            "git fetch origin main"
            "git checkout main"
            "git pull --ff-only origin main"
            "# Preflight: validate production env/compose/nginx before (re)deploying containers."
            "echo \"=== ATTENDANCE PREFLIGHT START ===\""
            "preflight_rc=0"
            "set +e"
            "COMPOSE_FILE=\"${DEPLOY_COMPOSE_FILE}\" ENV_FILE=\"docker/app.env\" NGINX_CONF=\"docker/nginx.conf\" scripts/ops/attendance-preflight.sh"
            'preflight_rc=$?'
            "set -e"
            "echo \"=== ATTENDANCE PREFLIGHT END ===\""
            'if [[ "$preflight_rc" != "0" ]]; then exit "$preflight_rc"; fi'
            "echo \"=== DEPLOY START ===\""
            "docker compose -f \"${DEPLOY_COMPOSE_FILE}\" pull backend web"
            "docker compose -f \"${DEPLOY_COMPOSE_FILE}\" up -d --no-deps --force-recreate backend web"
            "echo \"=== DEPLOY END ===\""
            "# Ensure DB schema is up to date before smoke checks."
            "echo \"=== MIGRATE START ===\""
            "# Important: redirect stdin so docker compose exec can't consume the rest of this bash -s script."
            "docker compose -f \"${DEPLOY_COMPOSE_FILE}\" exec -T backend node packages/core-backend/dist/src/db/migrate.js < /dev/null"
            "echo \"=== MIGRATE END ===\""
            "# Post-deploy smoke checks"
            "echo \"=== SMOKE START ===\""
            "for i in {1..10}; do"
              "  if curl -fsS http://127.0.0.1:8900/api/plugins >/dev/null; then"
            "    break"
            "  fi"
            "  sleep 3"
            "done"
            "curl -fsS http://127.0.0.1:8900/api/plugins >/dev/null"
            "curl -fsS http://127.0.0.1:8900/health >/dev/null"
            "curl -fsS http://127.0.0.1:8081 >/dev/null"
            "echo \"Smoke: api/plugins=ok health=ok web=ok\""
            "echo \"=== SMOKE END ===\""
          )
          set +e
          printf '%s\n' "${remote_cmds[@]}" | ssh $ssh_opts "$DEPLOY_USER@$DEPLOY_HOST" bash -s 2>&1 | tee "$deploy_log"
          rc=${PIPESTATUS[1]}
          set -e
          echo "deploy_rc=$rc" >> "$GITHUB_OUTPUT"
          echo "deploy_log=$deploy_log" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Write deploy summary (preflight + runbooks)
        if: always()
        env:
          DEPLOY_RC: ${{ steps.remote_deploy.outputs.deploy_rc }}
        run: |
          set -euo pipefail
          deploy_log="output/deploy/deploy.log"
          repo_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          artifact_name="deploy-logs-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          preflight_status="UNKNOWN"
          overall="UNKNOWN"
          if [[ -n "${DEPLOY_RC:-}" ]]; then
            overall="PASS"
            if [[ "${DEPLOY_RC}" != "0" ]]; then
              overall="FAIL"
            fi
          fi

          echo "## Deploy (Remote)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Overall: **${overall}**" >> "$GITHUB_STEP_SUMMARY"
          echo "- Remote exit code: \`${DEPLOY_RC:-missing}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Remote Preflight" >> "$GITHUB_STEP_SUMMARY"

          if [[ ! -f "$deploy_log" ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- Status: **UNKNOWN** (deploy.log missing)" >> "$GITHUB_STEP_SUMMARY"
          else
            preflight_block="$(
              awk '
                /^=== ATTENDANCE PREFLIGHT START ===$/ { printing=1; next }
                /^=== ATTENDANCE PREFLIGHT END ===$/ { printing=0 }
                printing { print }
              ' "$deploy_log" | head -n 120
            )"

            if [[ -z "${preflight_block}" ]]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "- Status: **UNKNOWN** (markers missing, see deploy.log artifact)" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "Last 80 log lines:" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              tail -n 80 "$deploy_log" >> "$GITHUB_STEP_SUMMARY" || true
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            else
              if echo "$preflight_block" | grep -q "Preflight OK"; then
                preflight_status="PASS"
              elif echo "$preflight_block" | grep -q "\\[attendance-preflight\\] ERROR:"; then
                preflight_status="FAIL"
              fi
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "- Status: **${preflight_status}**" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "$preflight_block" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"

              if [[ "${overall}" == "FAIL" && "${preflight_status}" == "PASS" ]]; then
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo "- Note: preflight passed; failure happened after preflight (deploy/migrate/smoke). See \`${artifact_name}\`." >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
          fi

          if [[ -f "$deploy_log" ]]; then
            has() { grep -qF "$1" "$deploy_log"; }
            extract_block() {
              local start="$1"
              local end="$2"
              local max_lines="$3"
              awk -v start="$start" -v end="$end" '
                $0 == start { printing=1; next }
                $0 == end { printing=0 }
                printing { print }
              ' "$deploy_log" | head -n "$max_lines"
            }

            deploy_stage="UNKNOWN"
            if has "=== DEPLOY START ==="; then
              deploy_stage="FAIL"
              if has "=== DEPLOY END ==="; then
                deploy_stage="PASS"
              fi
            fi

            migrate_stage="UNKNOWN"
            if has "=== MIGRATE START ==="; then
              migrate_stage="FAIL"
              if has "=== MIGRATE END ==="; then
                migrate_stage="PASS"
              fi
            fi

            smoke_stage="UNKNOWN"
            if has "=== SMOKE START ==="; then
              smoke_stage="FAIL"
              if grep -q "Smoke: api/plugins=ok health=ok web=ok" "$deploy_log"; then
                smoke_stage="PASS"
              elif has "=== SMOKE END ==="; then
                smoke_stage="UNKNOWN"
              fi
            fi

            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Remote Stages" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- Deploy: **${deploy_stage}**" >> "$GITHUB_STEP_SUMMARY"
            echo "- Migrate: **${migrate_stage}**" >> "$GITHUB_STEP_SUMMARY"
            echo "- Smoke: **${smoke_stage}**" >> "$GITHUB_STEP_SUMMARY"

            if [[ "${migrate_stage}" != "PASS" && "${migrate_stage}" != "UNKNOWN" ]]; then
              migrate_block="$(extract_block "=== MIGRATE START ===" "=== MIGRATE END ===" 80 || true)"
              if [[ -n "${migrate_block}" ]]; then
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo "### Migrate Output (tail)" >> "$GITHUB_STEP_SUMMARY"
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
                echo "$migrate_block" >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
              fi
            fi

            if [[ "${smoke_stage}" != "PASS" && "${smoke_stage}" != "UNKNOWN" ]]; then
              smoke_block="$(extract_block "=== SMOKE START ===" "=== SMOKE END ===" 80 || true)"
              if [[ -n "${smoke_block}" ]]; then
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo "### Smoke Output (tail)" >> "$GITHUB_STEP_SUMMARY"
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
                echo "$smoke_block" >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Deploy logs artifact: \`${artifact_name}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Local evidence path (after download): \`output/playwright/ga/${GITHUB_RUN_ID}/deploy.log\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Download:" >> "$GITHUB_STEP_SUMMARY"
          echo '```bash' >> "$GITHUB_STEP_SUMMARY"
          echo "gh run download ${GITHUB_RUN_ID} -n \"${artifact_name}\" -D \"output/playwright/ga/${GITHUB_RUN_ID}\"" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Runbooks" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Upload channel troubleshooting: ${repo_url}/blob/main/docs/attendance-production-import-upload-channel-20260212.md" >> "$GITHUB_STEP_SUMMARY"
          echo "- Production delivery checklist: ${repo_url}/blob/main/docs/attendance-production-delivery-20260207.md" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload deploy artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs-${{ github.run_id }}-${{ github.run_attempt }}
          retention-days: 14
          path: |
            output/deploy/**

      - name: Fail when remote deploy failed
        if: always()
        run: |
          rc="${{ steps.remote_deploy.outputs.deploy_rc }}"
          if [[ -z "$rc" ]]; then
            echo "deploy_rc missing; failing deploy job." >&2
            exit 1
          fi
          if [[ "$rc" != "0" ]]; then
            echo "Remote deploy failed: rc=$rc" >&2
            exit 1
          fi
