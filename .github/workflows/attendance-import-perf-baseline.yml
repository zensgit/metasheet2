name: Attendance Import Perf Baseline

# Mark drill runs explicitly so dashboards can ignore them.
run-name: Attendance Import Perf Baseline${{ github.event_name == 'workflow_dispatch' && inputs.drill == 'true' && ' [DRILL]' || '' }}

on:
  workflow_dispatch:
    inputs:
      drill:
        description: 'Optional: mark run as [DRILL] and skip calling production APIs (true/false)'
        required: false
        default: 'false'
      drill_fail:
        description: 'Optional: intentionally fail the drill job for FAIL-path validation (true/false)'
        required: false
        default: 'false'
      issue_title:
        description: 'Optional: override issue title for workflow_dispatch drills (leave empty for production title)'
        required: false
        default: ''
      api_base:
        description: 'API base (must end with /api)'
        required: false
        default: 'http://142.171.239.56:8081/api'
      rows:
        description: 'CSV rows to generate (default 10000)'
        required: false
        default: '10000'
      mode:
        description: 'preview or commit'
        required: false
        default: 'commit'
      commit_async:
        description: 'Use /commit-async path (true/false)'
        required: false
        default: 'true'
      export_csv:
        description: 'Verify export csv latency (true/false)'
        required: false
        default: 'true'
      upload_csv:
        description: 'Upload CSV via /attendance/import/upload (true/false)'
        required: false
        default: 'true'
      max_preview_ms:
        description: 'Fail if preview latency exceeds this value (optional)'
        required: false
        default: ''
      max_commit_ms:
        description: 'Fail if commit latency exceeds this value (optional)'
        required: false
        default: ''
      max_export_ms:
        description: 'Fail if export latency exceeds this value (optional)'
        required: false
        default: ''
      max_rollback_ms:
        description: 'Fail if rollback latency exceeds this value (optional)'
        required: false
        default: ''
  schedule:
    # Daily at 03:20 UTC (after strict gates job window).
    - cron: '20 3 * * *'

concurrency:
  group: attendance-import-perf-baseline
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  drill:
    if: github.event_name == 'workflow_dispatch' && inputs.drill == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      DRILL_FAIL: ${{ inputs.drill_fail || 'false' }}
    steps:
      - name: Drill no-op (skip perf baseline)
        run: |
          set -euo pipefail
          DRILL_FAIL="${DRILL_FAIL:-false}"
          mkdir -p output/playwright/attendance-import-perf/drill
          cat > output/playwright/attendance-import-perf/drill/drill.txt <<'EOF'
          This is a DRILL run for Attendance Import Perf Baseline.
          The workflow intentionally skips calling production APIs.
          EOF

          # Provide a minimal perf-summary.json so dashboards can exercise
          # artifact parsing without calling production.
          cat > output/playwright/attendance-import-perf/drill/perf-summary.json <<'EOF'
          {
            "startedAt": "1970-01-01T00:00:00.000Z",
            "scenario": "DRILL",
            "mode": "commit",
            "apiBase": "<DRILL>",
            "orgId": "default",
            "rows": 10000,
            "commitAsync": true,
            "uploadCsv": true,
            "previewMs": 1111,
            "commitMs": 2222,
            "exportMs": 333,
            "rollbackMs": 44,
            "thresholds": {
              "maxPreviewMs": 100000,
              "maxCommitMs": 150000,
              "maxExportMs": 25000,
              "maxRollbackMs": 8000
            },
            "regressions": [
              "DRILL: synthetic regression entry"
            ]
          }
          EOF

          if [[ "$DRILL_FAIL" == "true" ]]; then
            echo "DRILL_FAIL=true: intentional failure after creating drill artifacts" >&2
            exit 97
          fi

      - name: Upload drill artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attendance-import-perf-${{ github.run_id }}-${{ github.run_attempt }}
          retention-days: 14
          path: |
            output/playwright/attendance-import-perf/**

  perf:
    if: github.event_name != 'workflow_dispatch' || inputs.drill != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      API_BASE: ${{ inputs.api_base || vars.ATTENDANCE_API_BASE || 'http://142.171.239.56:8081/api' }}
      AUTH_TOKEN: ${{ secrets.ATTENDANCE_ADMIN_JWT }}
      ROWS: ${{ inputs.rows || '10000' }}
      MODE: ${{ inputs.mode || 'commit' }}
      ROLLBACK: 'true'
      COMMIT_ASYNC: ${{ inputs.commit_async || vars.ATTENDANCE_PERF_COMMIT_ASYNC || 'true' }}
      EXPORT_CSV: ${{ inputs.export_csv || vars.ATTENDANCE_PERF_EXPORT_CSV || 'true' }}
      UPLOAD_CSV: ${{ inputs.upload_csv || vars.ATTENDANCE_PERF_UPLOAD_CSV || 'true' }}
      MAX_PREVIEW_MS: ${{ inputs.max_preview_ms || vars.ATTENDANCE_PERF_MAX_PREVIEW_MS || '' }}
      MAX_COMMIT_MS: ${{ inputs.max_commit_ms || vars.ATTENDANCE_PERF_MAX_COMMIT_MS || '' }}
      MAX_EXPORT_MS: ${{ inputs.max_export_ms || vars.ATTENDANCE_PERF_MAX_EXPORT_MS || '' }}
      MAX_ROLLBACK_MS: ${{ inputs.max_rollback_ms || vars.ATTENDANCE_PERF_MAX_ROLLBACK_MS || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run perf baseline (rollback enabled)
        run: |
          set -euo pipefail
          # Always capture logs so failures are diagnosable from artifacts.
          mkdir -p output/playwright/attendance-import-perf
          node ./scripts/ops/attendance-import-perf.mjs 2>&1 | tee output/playwright/attendance-import-perf/perf.log

      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attendance-import-perf-${{ github.run_id }}-${{ github.run_attempt }}
          retention-days: 14
          path: |
            output/playwright/attendance-import-perf/**

  issue:
    name: Perf Issue Alert (P1)
    needs: [drill, perf]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      DRILL: ${{ github.event.inputs.drill || 'false' }}
      DRILL_FAIL: ${{ github.event.inputs.drill_fail || 'false' }}
      ISSUE_TITLE_OVERRIDE: ${{ github.event.inputs.issue_title || '' }}
      DRILL_RESULT: ${{ needs.drill.result }}
      PERF_RESULT: ${{ needs.perf.result }}
    steps:
      - name: Open/update issue on failure (P1, no paging)
        uses: actions/github-script@v7
        with:
          script: |
            const drill = String(process.env.DRILL || '').trim() === 'true'
            const drillFail = String(process.env.DRILL_FAIL || '').trim() === 'true'
            const drillResult = String(process.env.DRILL_RESULT || '').trim()
            const perfResult = String(process.env.PERF_RESULT || '').trim()
            const titleOverride = String(process.env.ISSUE_TITLE_OVERRIDE || '').trim()

            const defaultTitle = '[Attendance P1] Perf baseline alert'
            const title = titleOverride || defaultTitle

            const allowIssueOps = !drill || Boolean(titleOverride)
            if (!allowIssueOps) {
              core.info('Drill run: skipping issue operations (no override title).')
              return
            }

            const owner = context.repo.owner
            const repo = context.repo.repo
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`
            const artifactName = `attendance-import-perf-${context.runId}-${process.env.GITHUB_RUN_ATTEMPT || '1'}`

            const failed = drillResult === 'failure' || perfResult === 'failure'
            const statusLine = `jobs: perf=${perfResult || 'unknown'} drill=${drillResult || 'unknown'}${drill && drillFail ? ' (drill_fail=true)' : ''}`

            const body = [
              'Automated perf baseline tracking issue (P1, no paging).',
              '',
              `Run: ${runUrl}`,
              statusLine,
              '',
              `Artifacts: ${artifactName}`,
              '',
              'Download:',
              '```bash',
              `gh run download ${context.runId} -n \"${artifactName}\" -D \"output/playwright/ga/${context.runId}\"`,
              '```',
            ].join('\n')

            const q = `repo:${owner}/${repo} type:issue in:title \"${title}\"`
            const search = await github.rest.search.issuesAndPullRequests({
              q,
              sort: 'updated',
              order: 'desc',
              per_page: 20,
            })
            const items = Array.isArray(search.data.items) ? search.data.items : []
            const match = items.find((item) => item && !item.pull_request && item.title === title) || null

            if (failed) {
              if (match) {
                if (match.state !== 'open') {
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: match.number,
                    state: 'open',
                    body,
                  })
                  core.info(`Reopened issue #${match.number}`)
                } else {
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: match.number,
                    body,
                  })
                  core.info(`Commented on issue #${match.number}`)
                }
                return
              }

              const created = await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
              })
              core.info(`Created issue #${created.data.number}`)
              return
            }

            // Recovery: close an existing open issue when the perf gate passes.
            if (!match) {
              core.info('No perf baseline issue found; nothing to close.')
              return
            }
            if (match.state !== 'open') {
              core.info(`Perf issue exists but is already closed (#${match.number}).`)
              return
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: match.number,
              body: [
                'Perf baseline recovery detected. Closing issue.',
                '',
                `Run: ${runUrl}`,
                statusLine,
              ].join('\n'),
            })
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: match.number,
              state: 'closed',
            })
            core.info(`Closed issue #${match.number}`)
