name: Attendance Strict Gates (Prod)

# Mark drill runs explicitly so dashboards can ignore them.
run-name: Attendance Strict Gates (Prod)${{ github.event_name == 'workflow_dispatch' && inputs.drill == 'true' && ' [DRILL]' || '' }}

on:
  workflow_dispatch:
    inputs:
      drill:
        description: 'Optional: mark run as [DRILL] and skip calling production APIs (true/false)'
        required: false
        default: 'false'
      drill_fail:
        description: 'Optional: intentionally fail the drill job for FAIL-path validation (true/false)'
        required: false
        default: 'false'
      drill_api_smoke_reason:
        description: 'Optional: apiSmoke reason code to embed in drill gate-summary.json (example: AUDIT_EXPORT_SCHEMA_MISSING)'
        required: false
        default: 'AUTH_FAILED'
      issue_title:
        description: 'Optional: override escalation issue title for workflow_dispatch drills (leave empty for production title)'
        required: false
        default: ''
      api_base:
        description: 'API base (must end with /api)'
        required: false
        default: 'http://142.171.239.56:8081/api'
      expect_product_mode:
        description: 'Expected product mode (from /api/auth/me -> features.mode)'
        required: false
        default: 'attendance'
      require_attendance_admin_api:
        description: 'Require attendance admin API endpoints (true/false)'
        required: false
        default: 'true'
      require_idempotency:
        description: 'Require import idempotencyKey retry behavior (true/false)'
        required: false
        default: 'true'
      require_import_export:
        description: 'Require import batch export.csv endpoint (true/false)'
        required: false
        default: 'true'
      require_import_upload:
        description: 'Require CSV upload channel (/attendance/import/upload + csvFileId) (true/false)'
        required: false
        default: 'true'
      require_import_async:
        description: 'Require async import commit gate (true/false)'
        required: false
        default: 'true'
      require_preview_async:
        description: 'Require async import preview gate (true/false)'
        required: false
        default: 'true'
      require_batch_resolve:
        description: 'Require attendance-admin batch user resolve API (true/false)'
        required: false
        default: 'false'
  schedule:
    # Daily at 02:15 UTC.
    - cron: '15 2 * * *'

concurrency:
  group: attendance-strict-gates-prod
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  drill:
    if: github.event_name == 'workflow_dispatch' && inputs.drill == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      DRILL_FAIL: ${{ inputs.drill_fail || 'false' }}
      DRILL_API_SMOKE_REASON: ${{ inputs.drill_api_smoke_reason || 'AUTH_FAILED' }}
    steps:
      - name: Drill no-op (skip strict gates)
        run: |
          set -euo pipefail
          DRILL_FAIL="${DRILL_FAIL:-false}"
          DRILL_API_SMOKE_REASON="${DRILL_API_SMOKE_REASON:-AUTH_FAILED}"
          if [[ ! "${DRILL_API_SMOKE_REASON}" =~ ^[A-Z0-9_]+$ ]]; then
            DRILL_API_SMOKE_REASON="AUTH_FAILED"
          fi
          mkdir -p output/playwright/attendance-prod-acceptance/drill
          cat > output/playwright/attendance-prod-acceptance/drill/drill.txt <<'EOF'
          This is a DRILL run for Attendance Strict Gates (Prod).
          The workflow intentionally skips calling production APIs.
          EOF

          # Provide a minimal gate-summary.json so dashboards can exercise
          # artifact parsing without calling production.
          cat > output/playwright/attendance-prod-acceptance/drill/gate-summary.json <<EOF
          {
            "generatedAt": "1970-01-01T00:00:00Z",
            "apiBase": "<DRILL>",
            "webUrl": "<DRILL>",
            "expectProductMode": "attendance",
            "exitCode": 1,
            "gates": {
              "preflight": "SKIP",
              "apiSmoke": "FAIL",
              "provisioning": "SKIP",
              "playwrightProd": "SKIP",
              "playwrightDesktop": "SKIP",
              "playwrightMobile": "SKIP"
            },
            "gateReasons": {
              "apiSmoke": "${DRILL_API_SMOKE_REASON}",
              "provisioning": null,
              "playwrightProd": null,
              "playwrightDesktop": null,
              "playwrightMobile": null
            }
          }
          EOF

          if [[ "$DRILL_FAIL" == "true" ]]; then
            echo "DRILL_FAIL=true: intentional failure after creating drill artifacts" >&2
            exit 97
          fi

      - name: Upload drill artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attendance-strict-gates-prod-${{ github.run_id }}-${{ github.run_attempt }}
          retention-days: 14
          path: |
            output/playwright/attendance-prod-acceptance/**

  strict-gates:
    if: github.event_name != 'workflow_dispatch' || inputs.drill != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      API_BASE: ${{ inputs.api_base || vars.ATTENDANCE_API_BASE || 'http://142.171.239.56:8081/api' }}
      AUTH_TOKEN: ${{ secrets.ATTENDANCE_ADMIN_JWT }}
      PROVISION_USER_ID: ${{ vars.ATTENDANCE_PROVISION_USER_ID }}
      EXPECT_PRODUCT_MODE: ${{ inputs.expect_product_mode || 'attendance' }}
      RUN_PREFLIGHT: 'false'
      REQUIRE_ATTENDANCE_ADMIN_API: ${{ inputs.require_attendance_admin_api || 'true' }}
      REQUIRE_IDEMPOTENCY: ${{ inputs.require_idempotency || 'true' }}
      REQUIRE_IMPORT_EXPORT: ${{ inputs.require_import_export || 'true' }}
      REQUIRE_IMPORT_UPLOAD: ${{ inputs.require_import_upload || 'true' }}
      REQUIRE_IMPORT_ASYNC: ${{ inputs.require_import_async || 'true' }}
      REQUIRE_PREVIEW_ASYNC: ${{ inputs.require_preview_async || 'true' }}
      REQUIRE_BATCH_RESOLVE: ${{ inputs.require_batch_resolve || 'false' }}
      HEADLESS: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run strict gates twice (remote)
        run: |
          set -euo pipefail
          ./scripts/ops/attendance-run-strict-gates-twice.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attendance-strict-gates-prod-${{ github.run_id }}-${{ github.run_attempt }}
          retention-days: 14
          path: |
            output/playwright/attendance-prod-acceptance/**

  escalate:
    name: Escalate Issue On Failure (Fast Alert)
    needs: [drill, strict-gates]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      DRILL: ${{ github.event.inputs.drill || 'false' }}
      ISSUE_TITLE_OVERRIDE: ${{ github.event.inputs.issue_title || '' }}
      DRILL_FAIL: ${{ github.event.inputs.drill_fail || 'false' }}
      DRILL_RESULT: ${{ needs.drill.result }}
      STRICT_RESULT: ${{ needs.strict-gates.result }}
    steps:
      - name: Escalate issue when strict gates failed
        uses: actions/github-script@v7
        with:
          script: |
            const drill = String(process.env.DRILL || '').trim() === 'true'
            const drillFail = String(process.env.DRILL_FAIL || '').trim() === 'true'
            const drillResult = String(process.env.DRILL_RESULT || '').trim()
            const strictResult = String(process.env.STRICT_RESULT || '').trim()
            const titleOverride = String(process.env.ISSUE_TITLE_OVERRIDE || '').trim()

            const failed = drillResult === 'failure' || strictResult === 'failure'
            if (!failed) {
              core.info('No failing job detected; skipping issue escalation.')
              return
            }

            const defaultTitle = '[Attendance Gate] Daily dashboard alert'
            const title = titleOverride || defaultTitle
            const allowEscalate = !drill || Boolean(titleOverride)
            if (!allowEscalate) {
              core.info('Drill run: skipping issue escalation (no override title).')
              return
            }

            const owner = context.repo.owner
            const repo = context.repo.repo
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`
            const artifactName = `attendance-strict-gates-prod-${context.runId}-${process.env.GITHUB_RUN_ATTEMPT || '1'}`

            const body = [
              'Automated strict gates escalation.',
              '',
              `Run: ${runUrl}`,
              `jobs: strict=${strictResult || 'unknown'} drill=${drillResult || 'unknown'}${drill && drillFail ? ' (drill_fail=true)' : ''}`,
              '',
              `Artifacts: ${artifactName}`,
              '',
              'Download:',
              '```bash',
              `gh run download ${context.runId} -n \"${artifactName}\" -D \"output/playwright/ga/${context.runId}\"`,
              '```',
            ].join('\n')

            const q = `repo:${owner}/${repo} type:issue in:title \"${title}\"`
            const search = await github.rest.search.issuesAndPullRequests({
              q,
              sort: 'updated',
              order: 'desc',
              per_page: 20,
            })
            const items = Array.isArray(search.data.items) ? search.data.items : []
            const match = items.find((item) => item && !item.pull_request && item.title === title) || null

            if (match) {
              if (match.state !== 'open') {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: match.number,
                  state: 'open',
                  body,
                })
                core.info(`Reopened issue #${match.number}`)
              } else {
                core.info(`Escalation issue already open (#${match.number}); not spamming updates.`)
              }
              return
            }

            const created = await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
            })
            core.info(`Created issue #${created.data.number}`)
