name: Phase 5 Nightly Validation (with Regression)

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      metrics_url:
        description: 'Override metrics URL (default http://localhost:8900/metrics/prom)'
        required: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          corepack enable
          pnpm install --frozen-lockfile

      - name: Determine metrics URL
        id: cfg
        env:
          METRICS_URL_SECRET: ${{ secrets.METRICS_URL }}
        run: |
          URL_INPUT="${{ github.event.inputs.metrics_url }}"
          if [ -n "$URL_INPUT" ]; then
            echo "url=$URL_INPUT" >> $GITHUB_OUTPUT
          elif [ -n "$METRICS_URL_SECRET" ]; then
            echo "url=$METRICS_URL_SECRET" >> $GITHUB_OUTPUT
          else
            echo "url=" >> $GITHUB_OUTPUT
          fi

      - name: Probe metrics endpoint
        id: probe
        run: |
          URL="${{ steps.cfg.outputs.url }}"
          if [ -z "$URL" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "No METRICS_URL provided; skipping validation." > /tmp/phase5.md
            echo '{"summary":{"overall_status":"na"}}' > /tmp/phase5.json
            exit 0
          fi
          if curl -sSf -m 5 "$URL" >/dev/null; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "Metrics endpoint unreachable: $URL" > /tmp/phase5.md
            echo '{"summary":{"overall_status":"na"}}' > /tmp/phase5.json
          fi

      - name: Run Phase 5 validation
        if: steps.probe.outputs.available == 'true'
        run: |
          bash scripts/phase5-full-validate.sh "${{ steps.cfg.outputs.url }}" /tmp/phase5.json || true
          bash scripts/phase5-generate-report.sh /tmp/phase5.json /tmp/phase5.md || true

      - name: Regression check (if baseline present)
        id: regression
        if: steps.probe.outputs.available == 'true'
        shell: bash
        run: |
          set -euo pipefail
          BASE="baseline/phase5-baseline.json"
          echo "present=false" >> "$GITHUB_OUTPUT"
          echo "regressed=false" >> "$GITHUB_OUTPUT"
          if [ -f "$BASE" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
            set +e
            bash scripts/phase5-regression-check.sh "$BASE" /tmp/phase5.json > /tmp/regression.txt 2>&1
            CODE=$?
            set -e
            if [ $CODE -ne 0 ]; then
              echo "regressed=true" >> "$GITHUB_OUTPUT"
              echo "Regression detected (exit $CODE)"
            else
              echo "Regression check PASS"
            fi
          else
            echo "No baseline file found; skipping regression check" | tee /tmp/regression.txt
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase5-validation
          path: |
            /tmp/phase5.json
            /tmp/phase5.md
            /tmp/regression.txt

      - name: Stage nightly JSON for repository trend tracking
        if: success() && steps.probe.outputs.available == 'true'
        run: |
          mkdir -p results/nightly
          cp /tmp/phase5.json "results/nightly/phase5-$(date -u '+%Y%m%d').json"
          echo "Staged results/nightly/phase5-$(date -u '+%Y%m%d').json"

      - name: Generate weekly trend markdown
        if: success() && steps.probe.outputs.available == 'true'
        run: |
          mkdir -p claudedocs
          bash scripts/phase5-weekly-trend.sh results/nightly claudedocs/PHASE5_WEEKLY_TREND.md 7 || echo "weekly trend generation skipped"

      - name: Generate SLO tightening suggestions
        if: success() && steps.probe.outputs.available == 'true'
        run: |
          bash scripts/phase5-slo-tighten-suggestions.sh results/nightly claudedocs/PHASE5_SLO_SUGGESTIONS.json 30 || echo "tighten suggestions skipped"

      - name: Create PR with nightly JSON (for trend, suggestions & baseline rotation)
        if: success() && steps.probe.outputs.available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore(phase5): nightly JSON, weekly trend & SLO suggestions $(date -u '+%Y-%m-%d')"
          title: "Phase5 Nightly: JSON + Trend + SLO Suggestions $(date -u '+%Y-%m-%d')"
          body: |
            Automated nightly Phase 5 validation.
            Includes:
            - Nightly JSON (results/nightly)
            - Weekly trend (last 7): claudedocs/PHASE5_WEEKLY_TREND.md
            - SLO tightening suggestions (window 30d): claudedocs/PHASE5_SLO_SUGGESTIONS.json
            Supports future baseline rotation after sustained PASS streak.
          branch: chore/phase5-nightly-$(date -u '+%Y%m%d')

      - name: Auto-rotate baseline (if streak met)
        if: success() && steps.probe.outputs.available == 'true'
        run: |
          bash scripts/phase5-baseline-auto-rotate.sh results/nightly baseline/phase5-baseline.json 14 || true
          # If CACHE_IMPL=redis and redis baseline link exists, ensure redis-specific baseline persisted
          if [ "${CACHE_IMPL:-memory}" = "redis" ] && [ -f baseline/phase5-baseline-redis.json ]; then
            echo "Redis baseline link present: baseline/phase5-baseline-redis.json"
          fi

      - name: Fail if overall status is not pass
        if: steps.probe.outputs.available == 'true'
        run: |
          status=$(jq -r '.summary.overall_status' /tmp/phase5.json 2>/dev/null || echo fail)
          echo "Overall status: $status"
          if [ "$status" != "pass" ]; then
            echo "Phase 5 validation failed"
            exit 1
          fi

      - name: Fail if regression detected
        if: steps.probe.outputs.available == 'true' && steps.regression.outputs.present == 'true' && steps.regression.outputs.regressed == 'true'
        run: |
          echo "Regression detected by scripts/phase5-regression-check.sh"
          exit 1

      - name: Notify Slack on failure (with regression details)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          METRICS_URL: ${{ steps.cfg.outputs.url }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification"
            exit 0
          fi
          # Use helper script to build failure summary (suggestions/audit may be absent)
          bash scripts/phase5-build-slack-summary.sh /tmp/phase5.json baseline/phase5-baseline.json claudedocs/PHASE5_SLO_SUGGESTIONS.json /tmp/cache_audit.txt > /tmp/slack_summary.txt || echo "summary build failed" > /tmp/slack_summary.txt
          curl -s -X POST -H 'Content-type: application/json' --data "$(jq -Rs '{text:.}' /tmp/slack_summary.txt)" "$SLACK_WEBHOOK_URL" || true

      - name: Notify Slack on success (summary & deltas)
        if: success() && steps.probe.outputs.available == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          METRICS_URL: ${{ steps.cfg.outputs.url }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack success notification"; exit 0
          fi
          # Build cache audit first (non-fatal)
          if [ -n "$METRICS_URL" ]; then bash scripts/phase5-cache-audit.sh "$METRICS_URL" 30 70 > /tmp/cache_audit.txt 2>&1 || echo "cache audit failed" > /tmp/cache_audit.txt; fi
          bash scripts/phase5-build-slack-summary.sh /tmp/phase5.json baseline/phase5-baseline.json claudedocs/PHASE5_SLO_SUGGESTIONS.json /tmp/cache_audit.txt > /tmp/slack_summary.txt || echo "summary build failed" > /tmp/slack_summary.txt
          curl -s -X POST -H 'Content-type: application/json' --data "$(jq -Rs '{text:.}' /tmp/slack_summary.txt)" "$SLACK_WEBHOOK_URL" || true
