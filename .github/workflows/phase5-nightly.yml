name: Phase 5 Nightly Validation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      metrics_url:
        description: 'Override metrics URL (e.g., https://env/metrics/prom)'
        required: false

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      METRICS_URL: ${{ github.event.inputs.metrics_url || secrets.METRICS_URL }}
      METRICS_AUTH_HEADER: ${{ secrets.METRICS_AUTH_HEADER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure metrics URL configured
        shell: bash
        run: |
          if [ -z "${METRICS_URL}" ]; then
            echo "METRICS_URL not set via input or secret; skipping validation." > unreachable.txt
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Using METRICS_URL=${METRICS_URL}"
          fi
        id: config

      - name: Probe metrics endpoint
        if: steps.config.outputs.skip != 'true'
        shell: bash
        run: |
          set -e
          HDRS=()
          if [ -n "${METRICS_AUTH_HEADER}" ]; then
            HDRS=( -H "${METRICS_AUTH_HEADER}" )
          fi
          # Try a quick HEAD, fall back to GET
          if ! curl -sS -I "${METRICS_URL}" "${HDRS[@]}" | head -n 1 | grep -q "200"; then
            if ! curl -sS "${METRICS_URL}" "${HDRS[@]}" | head -n 1 >/dev/null; then
              echo "Metrics endpoint unreachable: ${METRICS_URL}" > unreachable.txt
              echo "skip=true" >> $GITHUB_OUTPUT
            fi
          fi
        id: probe

      - name: Set up Node
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        run: |
          npm ci || pnpm i || yarn install

      - name: Run Phase 5 validation
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        shell: bash
        env:
          METRICS_URL: ${{ env.METRICS_URL }}
          METRICS_AUTH_HEADER: ${{ env.METRICS_AUTH_HEADER }}
        run: |
          # Export auth header to scripts when supported
          if [ -n "${METRICS_AUTH_HEADER}" ]; then
            export EXTRA_CURL_HEADER="${METRICS_AUTH_HEADER}"
          fi
          bash scripts/phase5-full-validate.sh "${METRICS_URL}" /tmp/phase5.json
          bash scripts/phase5-generate-report.sh /tmp/phase5.json /tmp/phase5.md

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase5-validation
          path: |
            /tmp/phase5.json
            /tmp/phase5.md
            unreachable.txt

      - name: Fail on non-pass summary
        if: steps.config.outputs.skip != 'true' && steps.probe.outputs.skip != 'true'
        shell: bash
        run: |
          STATUS=$(jq -r '.summary.overall_status' /tmp/phase5.json || echo 'fail')
          echo "Overall status: ${STATUS}"
          if [ "${STATUS}" != "pass" ]; then
            echo "Phase 5 validation failed (overall_status=${STATUS})." >&2
            exit 1
          fi

      - name: Slack notify on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL || 'alerts' }}
          SLACK_USERNAME: 'Phase5 CI'
          SLACK_ICON_EMOJI: ':rotating_light:'
          SLACK_TITLE: 'Phase 5 Nightly Validation Failed'
          SLACK_MESSAGE: 'Check artifacts phase5.json/md and metrics endpoint reachability.'
