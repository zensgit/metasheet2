name: Migration Replay

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'feat/**'
    paths:
      - 'packages/core-backend/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/migration-replay.yml'

jobs:
  migration-replay:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.1
          run_install: false
      - name: Show pnpm version
        run: pnpm -v
      - name: Use empty npmrc for pnpm
        run: |
          echo "" > /tmp/empty-npmrc
          echo "NPM_CONFIG_USERCONFIG=/tmp/empty-npmrc" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile 2>&1 | tee install.log
        shell: bash

      - name: Start Postgres
        uses: ankane/setup-postgres@v1
        with:
          postgres-version: 15

      - name: Wait for Postgres readiness
        run: |
          for i in {1..60}; do
            pg_isready -h 127.0.0.1 -p 5432 && exit 0 || sleep 1
          done
          echo "Postgres not ready in time" >&2
          exit 1

      - name: Create DB and extension
        run: |
          createdb metasheet || true
          psql -d metasheet -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
        timeout-minutes: 2

      - name: Run migrations twice (replay)
        env:
          DATABASE_URL: postgresql://127.0.0.1/metasheet
          # Exclude 008_plugin_infrastructure.sql - has idempotency issue with scope column
          # TODO: Fix migration to be fully idempotent or split into separate migrations
          # Exclude 048-049 - Phase 2 Event Bus/BPMN migrations with complex SQL syntax issues
          # TODO: Rewrite these migrations with correct PostgreSQL syntax
          # Exclude 20250924120000_create_views_view_states.ts - View states migration with schema issues
          # Exclude 042a_core_model_views.sql - References non-existent last_accessed column
          # TODO: Fix last_accessed column reference in 042a_core_model_views.sql
          MIGRATION_EXCLUDE: 008_plugin_infrastructure.sql,048_create_event_bus_tables.sql,049_create_bpmn_workflow_tables.sql,042a_core_model_views.sql,20250924120000_create_views_view_states.ts
        run: |
          pnpm -F @metasheet/core-backend db:migrate
          pnpm -F @metasheet/core-backend db:migrate
      - name: List migrations
        env:
          DATABASE_URL: postgresql://127.0.0.1/metasheet
        run: pnpm -F @metasheet/core-backend db:list

      - name: Upload install logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: migration-replay-install-logs
          path: |
            install.log
            pnpm-lock.yaml
            packages/**/package.json
