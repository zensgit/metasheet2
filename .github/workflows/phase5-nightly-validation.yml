name: Phase 5 Nightly Validation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      metrics_url:
        description: 'Override metrics URL (default http://localhost:8900/metrics/prom)'
        required: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          corepack enable
          pnpm install --frozen-lockfile

      - name: Determine metrics URL
        id: cfg
        env:
          METRICS_URL_SECRET: ${{ secrets.METRICS_URL }}
        run: |
          URL_INPUT="${{ github.event.inputs.metrics_url }}"
          if [ -n "$URL_INPUT" ]; then
            echo "url=$URL_INPUT" >> $GITHUB_OUTPUT
          elif [ -n "$METRICS_URL_SECRET" ]; then
            echo "url=$METRICS_URL_SECRET" >> $GITHUB_OUTPUT
          else
            echo "url=" >> $GITHUB_OUTPUT
          fi

      - name: Probe metrics endpoint
        id: probe
        run: |
          URL="${{ steps.cfg.outputs.url }}"
          if [ -z "$URL" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "No METRICS_URL provided; skipping validation." > /tmp/phase5.md
            echo '{"summary":{"overall_status":"na"}}' > /tmp/phase5.json
            exit 0
          fi
          if curl -sSf -m 5 "$URL" >/dev/null; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "Metrics endpoint unreachable: $URL" > /tmp/phase5.md
            echo '{"summary":{"overall_status":"na"}}' > /tmp/phase5.json
          fi

      - name: Run Phase 5 validation
        if: steps.probe.outputs.available == 'true'
        run: |
          bash scripts/phase5-full-validate.sh "${{ steps.cfg.outputs.url }}" /tmp/phase5.json || true
          bash scripts/phase5-generate-report.sh /tmp/phase5.json /tmp/phase5.md || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase5-validation
          path: |
            /tmp/phase5.json
            /tmp/phase5.md

      - name: Fail if overall status is not pass
        if: steps.probe.outputs.available == 'true'
        run: |
          status=$(jq -r '.summary.overall_status' /tmp/phase5.json 2>/dev/null || echo fail)
          echo "Overall status: $status"
          if [ "$status" != "pass" ]; then
            echo "Phase 5 validation failed"
            exit 1
          fi

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification"
            exit 0
          fi
          summary=$(jq -r '.summary | "Total: \(.total_checks) | Passed: \(.passed) | Failed: \(.failed) | NA: \(.na) | Status: \(.overall_status)"' /tmp/phase5.json 2>/dev/null || echo "Phase 5 validation failed")
          pr_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          payload=$(cat <<EOF
          {
            "text": "Phase 5 Nightly Validation FAILED",
            "blocks": [
              {"type":"section","text":{"type":"mrkdwn","text":"*Phase 5 Nightly Validation FAILED*\nRepo: ${{ github.repository }}\nRun: <$pr_url|View Run>"}},
              {"type":"section","text":{"type":"mrkdwn","text":"$summary"}}
            ]
          }
EOF
          )
          curl -s -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" || true
