name: Attendance Remote Docker GC (Prod)

# Remote maintenance workflow to reclaim disk space from unused docker images/caches.
# This is intentionally NOT scheduled; run manually when storage health indicates high disk usage.
run-name: Attendance Remote Docker GC (Prod)${{ github.event_name == 'workflow_dispatch' && inputs.skip_host_sync == 'true' && ' [DEBUG]' || '' }}

on:
  workflow_dispatch:
    inputs:
      prune:
        description: 'Run docker GC (docker system prune -af). true/false'
        required: false
        default: 'false'
      skip_host_sync:
        description: 'Optional: skip deploy-host git sync step (true/false). Use for debugging when host sync is broken.'
        required: false
        default: 'false'

concurrency:
  group: attendance-remote-docker-gc-prod
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docker-gc:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      gc_rc: ${{ steps.remote_gc.outputs.gc_rc }}
    steps:
      - name: Remote docker GC (with host sync logs)
        id: remote_gc
        continue-on-error: true
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY_B64: ${{ secrets.DEPLOY_SSH_KEY_B64 }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          PRUNE: ${{ github.event.inputs.prune || 'false' }}
          SKIP_HOST_SYNC: ${{ github.event.inputs.skip_host_sync || 'false' }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s' "$DEPLOY_SSH_KEY_B64" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh_opts="-o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o ServerAliveInterval=30 -o ServerAliveCountMax=6 -i ~/.ssh/deploy_key"

          DEPLOY_PATH="${DEPLOY_PATH:-metasheet2}"
          PRUNE="${PRUNE:-false}"
          SKIP_HOST_SYNC="${SKIP_HOST_SYNC:-false}"

          mkdir -p output/docker-gc
          gc_log="output/docker-gc/docker-gc.log"

          remote_cmds=(
            "set -euo pipefail"
            "DEPLOY_PATH=\"${DEPLOY_PATH}\""
            "PRUNE=\"${PRUNE}\""
            "SKIP_HOST_SYNC=\"${SKIP_HOST_SYNC}\""
            "cd \"${DEPLOY_PATH}\""
            "echo \"=== HOST SYNC START ===\""
            "host_sync_rc=0"
            'if [[ "${SKIP_HOST_SYNC}" == "true" ]]; then'
              '  echo "[host-sync] skipped (skip_host_sync=true)"'
              '  host_sync_rc=0'
            "else"
              "  set +e"
              "  git rev-parse --is-inside-work-tree >/dev/null 2>&1 && git fetch origin main && git checkout main && git pull --ff-only origin main"
              '  host_sync_rc=$?'
              "  set -e"
            "fi"
            'echo "[host-sync] rc=$host_sync_rc"'
            "echo \"=== HOST SYNC END ===\""
            'if [[ "$host_sync_rc" != "0" ]]; then exit "$host_sync_rc"; fi'
            "echo \"=== DOCKER GC START ===\""
            'echo "[docker-gc] df -h (before)"'
            'df -h || true'
            'echo ""'
            'echo "[docker-gc] docker system df (before)"'
            'docker system df || true'
            'echo ""'
            'if [[ "${PRUNE}" == "true" ]]; then'
              '  echo "[docker-gc] running: docker system prune -af (with heartbeat)"'
              '  set +e'
              '  prune_log="/tmp/attendance-docker-prune-$$.log"'
              '  docker system prune -af >"$prune_log" 2>&1 &'
              '  prune_pid=$!'
              '  while kill -0 "$prune_pid" 2>/dev/null; do'
              '    echo "[docker-gc] prune in progress (pid=$prune_pid) ..."'
              '    sleep 15'
              '  done'
              '  wait "$prune_pid"'
              '  prune_rc=$?'
              '  set -e'
              '  echo "[docker-gc] prune rc=$prune_rc"'
              '  echo "[docker-gc] prune output tail:"'
              '  tail -n 80 "$prune_log" || true'
              '  if [[ "$prune_rc" != "0" ]] && grep -q "a prune operation is already running" "$prune_log" 2>/dev/null; then'
              '    echo "[docker-gc] WARN: prune already running; continuing without failing"'
              '    prune_rc=0'
              '  fi'
              '  rm -f "$prune_log" || true'
              '  if [[ "$prune_rc" != "0" ]]; then exit "$prune_rc"; fi'
            "else"
              '  echo "[docker-gc] prune skipped (prune=false)"'
            "fi"
            'echo ""'
            'echo "[docker-gc] df -h (after)"'
            'df -h || true'
            'echo ""'
            'echo "[docker-gc] docker system df (after)"'
            'docker system df || true'
            "echo \"=== DOCKER GC END ===\""
          )

          set +e
          printf '%s\n' "${remote_cmds[@]}" | ssh $ssh_opts "$DEPLOY_USER@$DEPLOY_HOST" bash -s 2>&1 | tee "$gc_log"
          rc=${PIPESTATUS[1]}
          set -e
          echo "gc_rc=$rc" >> "$GITHUB_OUTPUT"
          echo "gc_log=$gc_log" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Write step summary (docker GC + runbooks)
        if: always()
        env:
          GC_RC: ${{ steps.remote_gc.outputs.gc_rc }}
          PRUNE: ${{ github.event.inputs.prune || 'false' }}
          SKIP_HOST_SYNC: ${{ github.event.inputs.skip_host_sync || 'false' }}
        run: |
          set -euo pipefail
          gc_log="output/docker-gc/docker-gc.log"
          repo_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          artifact_name="attendance-remote-docker-gc-prod-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          overall="UNKNOWN"
          if [[ -n "${GC_RC:-}" ]]; then
            overall="PASS"
            if [[ "${GC_RC}" != "0" ]]; then
              overall="FAIL"
            fi
          fi

          echo "## Remote Docker GC (Prod)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Overall: **${overall}**" >> "$GITHUB_STEP_SUMMARY"
          echo "- Remote exit code: \`${GC_RC:-missing}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Prune: \`${PRUNE}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Skip host sync: \`${SKIP_HOST_SYNC}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Output (snippet)" >> "$GITHUB_STEP_SUMMARY"
          if [[ ! -f "$gc_log" ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- Status: **UNKNOWN** (docker-gc.log missing)" >> "$GITHUB_STEP_SUMMARY"
          else
            block="$(
              awk '
                /^=== DOCKER GC START ===$/ { printing=1; next }
                /^=== DOCKER GC END ===$/ { printing=0 }
                printing { print }
              ' "$gc_log" | head -n 120
            )"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "${block:-'(markers missing; see docker-gc.log artifact)'}" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Docker GC logs artifact: \`${artifact_name}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Local evidence path (after download): \`output/playwright/ga/${GITHUB_RUN_ID}/docker-gc.log\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Download:" >> "$GITHUB_STEP_SUMMARY"
          echo '```bash' >> "$GITHUB_STEP_SUMMARY"
          echo "gh run download ${GITHUB_RUN_ID} -n \"${artifact_name}\" -D \"output/playwright/ga/${GITHUB_RUN_ID}\"" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Runbooks" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Daily gates handbook: ${repo_url}/blob/main/docs/attendance-production-ga-daily-gates-20260209.md" >> "$GITHUB_STEP_SUMMARY"
          echo "- Production delivery checklist: ${repo_url}/blob/main/docs/attendance-production-delivery-20260207.md" >> "$GITHUB_STEP_SUMMARY"

          mkdir -p output/docker-gc
          cp "$GITHUB_STEP_SUMMARY" output/docker-gc/step-summary.md

      - name: Upload docker GC artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attendance-remote-docker-gc-prod-${{ github.run_id }}-${{ github.run_attempt }}
          retention-days: 14
          path: |
            output/docker-gc/**

      - name: Fail when remote docker GC failed
        if: always()
        run: |
          rc="${{ steps.remote_gc.outputs.gc_rc }}"
          if [[ -z "$rc" ]]; then
            echo "gc_rc missing; failing workflow." >&2
            exit 1
          fi
          if [[ "$rc" != "0" ]]; then
            echo "Remote docker GC failed: rc=$rc" >&2
            exit 1
          fi
