#!/bin/bash
# scripts/cleanup-test-branches.sh
# Purpose: æ‰¹é‡æ¸…ç†æµ‹è¯•å’ŒéªŒè¯åˆ†æ”¯
# Author: DevOps Team
# Date: 2025-09-30

set -e

echo "=== æµ‹è¯•åˆ†æ”¯æ¸…ç†å·¥å…· ==="
echo ""

# 1. åˆ—å‡ºæ‰€æœ‰test/verifyåˆ†æ”¯
echo "ğŸ“‹ æ‰«ææµ‹è¯•åˆ†æ”¯..."
TEST_BRANCHES=$(git branch -r | grep -E "origin/(test|verify)-" | sed 's/origin\///' | sed 's/^[[:space:]]*//')

if [ -z "$TEST_BRANCHES" ]; then
  echo "âœ… æœªå‘ç°æµ‹è¯•åˆ†æ”¯ï¼Œæ— éœ€æ¸…ç†"
  exit 0
fi

echo ""
echo "å‘ç°ä»¥ä¸‹æµ‹è¯•åˆ†æ”¯:"
echo "$TEST_BRANCHES" | nl
echo ""

# 2. è¯¢é—®ç¡®è®¤
read -p "æ˜¯å¦ç»§ç»­æ¸…ç†è¿™äº›åˆ†æ”¯? [y/N] " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "å·²å–æ¶ˆæ¸…ç†"
  exit 0
fi

# 3. å½’æ¡£æŠ¥å‘Šåˆ°docs/archived-test-reports/
echo ""
echo "ğŸ“¦ å½’æ¡£æµ‹è¯•æŠ¥å‘Š..."
mkdir -p docs/archived-test-reports

ARCHIVED_COUNT=0
for branch in $TEST_BRANCHES; do
  echo "  å½’æ¡£ $branch..."

  # è·å–PRä¿¡æ¯
  PR_INFO=$(gh pr list --head "$branch" --json number,title,body,state --jq '.[0]' 2>/dev/null || echo "{}")

  if [ "$PR_INFO" != "{}" ]; then
    PR_NUM=$(echo "$PR_INFO" | jq -r '.number // "unknown"')
    PR_TITLE=$(echo "$PR_INFO" | jq -r '.title // "Unknown Title"')
    PR_BODY=$(echo "$PR_INFO" | jq -r '.body // "No description"')
    PR_STATE=$(echo "$PR_INFO" | jq -r '.state // "unknown"')

    # ç”Ÿæˆå½’æ¡£æ–‡ä»¶
    ARCHIVE_FILE="docs/archived-test-reports/${branch/\//_}.md"
    cat > "$ARCHIVE_FILE" <<EOF
# æµ‹è¯•åˆ†æ”¯å½’æ¡£: $branch

**PRç¼–å·**: #$PR_NUM
**æ ‡é¢˜**: $PR_TITLE
**çŠ¶æ€**: $PR_STATE
**å½’æ¡£æ—¥æœŸ**: $(date +%Y-%m-%d)

## åŸå§‹æè¿°

$PR_BODY

---

*æ­¤æ–‡ä»¶ç”± scripts/cleanup-test-branches.sh è‡ªåŠ¨ç”Ÿæˆ*
EOF

    ARCHIVED_COUNT=$((ARCHIVED_COUNT + 1))
  else
    echo "  âš ï¸  æœªæ‰¾åˆ°PRä¿¡æ¯ï¼ˆå¯èƒ½å·²å…³é—­æˆ–ä¸å­˜åœ¨PRï¼‰"
  fi
done

echo "  âœ… å½’æ¡£å®Œæˆ: $ARCHIVED_COUNT ä¸ªæŠ¥å‘Š"

# 4. å…³é—­PRå¹¶åˆ é™¤åˆ†æ”¯
echo ""
echo "ğŸ—‘ï¸  å…³é—­PRå¹¶åˆ é™¤åˆ†æ”¯..."
DELETED_COUNT=0
CLOSED_PR_COUNT=0

for branch in $TEST_BRANCHES; do
  # è·å–PRç¼–å·
  PR_NUM=$(gh pr list --head "$branch" --json number --jq '.[0].number' 2>/dev/null || echo "")

  if [ -n "$PR_NUM" ]; then
    echo "  å…³é—­ PR #$PR_NUM ($branch)..."
    gh pr close "$PR_NUM" --comment "âœ… æµ‹è¯•å·²å®Œæˆï¼ŒåŠŸèƒ½å·²åˆå¹¶åˆ°mainåˆ†æ”¯

å½’æ¡£æŠ¥å‘Šå·²ä¿å­˜è‡³: \`docs/archived-test-reports/${branch/\//_}.md\`

---
*ç”± scripts/cleanup-test-branches.sh è‡ªåŠ¨å…³é—­*" 2>/dev/null || echo "  âš ï¸  PRå·²å…³é—­æˆ–æ— æ³•è®¿é—®"
    CLOSED_PR_COUNT=$((CLOSED_PR_COUNT + 1))
  fi

  # åˆ é™¤è¿œç¨‹åˆ†æ”¯
  echo "  åˆ é™¤è¿œç¨‹åˆ†æ”¯ $branch..."
  git push origin --delete "$branch" 2>/dev/null || echo "  âš ï¸  åˆ†æ”¯å·²åˆ é™¤æˆ–ä¸å­˜åœ¨"
  DELETED_COUNT=$((DELETED_COUNT + 1))
done

echo ""
echo "=== æ¸…ç†å®Œæˆ ==="
echo "  ğŸ“¦ å½’æ¡£æŠ¥å‘Š: $ARCHIVED_COUNT ä¸ª"
echo "  ğŸ”’ å…³é—­PR: $CLOSED_PR_COUNT ä¸ª"
echo "  ğŸ—‘ï¸  åˆ é™¤åˆ†æ”¯: $DELETED_COUNT ä¸ª"
echo ""
echo "å½’æ¡£æŠ¥å‘Šä¿å­˜åœ¨: docs/archived-test-reports/"
echo ""

# 5. æäº¤å½’æ¡£æŠ¥å‘Šåˆ°git
if [ $ARCHIVED_COUNT -gt 0 ]; then
  echo "ğŸ“ æäº¤å½’æ¡£æŠ¥å‘Š..."
  git add docs/archived-test-reports/
  git commit -m "chore: archive test branch reports

Archived $ARCHIVED_COUNT test branch reports before cleanup.

Branches cleaned:
$(echo "$TEST_BRANCHES" | sed 's/^/- /')

ğŸ¤– Generated by scripts/cleanup-test-branches.sh
"
  echo "  âœ… å½’æ¡£æŠ¥å‘Šå·²æäº¤åˆ°git"
fi

echo ""
echo "âœ¨ å…¨éƒ¨å®Œæˆï¼"
