groups:
  - name: phase5-slo
    rules:
      - alert: HttpSuccessRateLow
        expr: (sum(rate(metasheet_http_requests_total{result="success"}[5m])) / sum(rate(metasheet_http_requests_total[5m]))) < 0.98
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: HTTP success rate below 98%
          runbook: SLO Phase5 â†’ Check recent deploy, inspect error logs, confirm upstream health.

      - alert: CacheHitRateLow
        expr: (sum(rate(cache_hits_total[10m])) / (sum(rate(cache_hits_total[10m])) + sum(rate(cache_miss_total[10m])))) < 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Cache hit rate below 80%
          runbook: Warm cache, verify FEATURE_CACHE enabled, inspect key churn.

      - alert: FallbackEffectiveHigh
        expr: (sum(rate(metasheet_fallback_effective_total[10m])) / sum(rate(metasheet_fallback_total[10m]))) > 0.6
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Fallback effective ratio above 0.6
          runbook: Check underlying causes (http_error, upstream_error), validate cache misses excluded.

      - alert: PluginReloadLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(metasheet_plugin_reload_duration_seconds_bucket[5m]))) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Plugin reload p95 latency above 2s
          runbook: Inspect plugin loader logs, recent plugin code changes.

      - alert: PluginReloadLatencyP99High
        expr: histogram_quantile(0.99, sum by (le) (rate(metasheet_plugin_reload_duration_seconds_bucket[5m]))) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Plugin reload p99 latency above 5s
          runbook: Same as p95; consider profiling reload path.

      - alert: SnapshotCreateLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(metasheet_snapshot_operation_duration_seconds_bucket{operation="create"}[5m]))) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Snapshot create p95 latency above 5s
          runbook: Check storage backend, recent snapshot volume, IO saturation.

      - alert: SnapshotRestoreLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(metasheet_snapshot_operation_duration_seconds_bucket{operation="restore"}[5m]))) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Snapshot restore p95 latency above 5s
          runbook: Validate restore path, data size growth, concurrency.

      - alert: MemoryRssHigh
        expr: metasheet_memory_rss_bytes > 500 * 1024 * 1024
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Memory RSS above 500MB
          runbook: Capture heap snapshot, inspect recent plugin/snapshot operations.
      - alert: RedisGetLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(redis_operation_duration_seconds_bucket{op="get"}[5m]))) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Redis GET p95 latency above 50ms
          runbook: Check Redis connectivity, network latency, slow commands.
      - alert: RedisSetLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(redis_operation_duration_seconds_bucket{op="set"}[5m]))) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Redis SET p95 latency above 50ms
          runbook: Investigate write path, persistence, AOF/RDB performance.
      - alert: RedisGetLatencyP95HighLong
        expr: metasheet:redis_get_p95:30m > 0.04
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Redis GET 30m p95 latency above 40ms
          runbook: Sustained latency; inspect slowlog, network, CPU, eviction policy.
      - alert: RedisSetLatencyP95HighLong
        expr: metasheet:redis_set_p95:30m > 0.04
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Redis SET 30m p95 latency above 40ms
          runbook: Sustained write latency; review persistence config, disk IO.
      - alert: RedisFailuresRecent
        expr: metasheet:redis_fail_rate:5m > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Redis recovery errors in last 5m
          runbook: Review redis_recovery_attempts_total{result="error"}, connectivity, failover; consider fallback to memory.
