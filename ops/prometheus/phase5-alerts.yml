groups:
  - name: phase5-slo
    rules:
      - alert: HttpSuccessRateLow
        expr: (sum(rate(metasheet_http_requests_total{result="success"}[5m])) / sum(rate(metasheet_http_requests_total[5m]))) < 0.98
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: HTTP success rate below 98%

      - alert: CacheHitRateLow
        expr: (sum(rate(cache_hits_total[10m])) / (sum(rate(cache_hits_total[10m])) + sum(rate(cache_miss_total[10m])))) < 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Cache hit rate below 80%

      - alert: FallbackEffectiveHigh
        expr: (sum(rate(metasheet_fallback_effective_total[10m])) / sum(rate(metasheet_fallback_total[10m]))) > 0.6
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Fallback effective ratio above 0.6

      - alert: PluginReloadLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(metasheet_plugin_reload_duration_seconds_bucket[5m]))) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Plugin reload p95 latency above 2s

      - alert: PluginReloadLatencyP99High
        expr: histogram_quantile(0.99, sum by (le) (rate(metasheet_plugin_reload_duration_seconds_bucket[5m]))) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Plugin reload p99 latency above 5s

      - alert: SnapshotCreateLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(metasheet_snapshot_operation_duration_seconds_bucket{operation="create"}[5m]))) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Snapshot create p95 latency above 5s

      - alert: SnapshotRestoreLatencyP95High
        expr: histogram_quantile(0.95, sum by (le) (rate(metasheet_snapshot_operation_duration_seconds_bucket{operation="restore"}[5m]))) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Snapshot restore p95 latency above 5s

      - alert: MemoryRssHigh
        expr: metasheet_memory_rss_bytes > 500 * 1024 * 1024
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Memory RSS above 500MB
